% ImageClass function
function [MFout,labels] = calcMF(self,vec,thresh,n,varargin)
% Calculate Minkowski Functionals
% Inputs:   vec = 4D image index to perform analysis on
%           optional Name/Value pairs:
%               'Thresh'  = vector of thresholds to use
%               'Window'  = radius (voxels) of moving window
%                               *(use inf if you want whole-image)
%               'ApplyMask' = check for use of existing VOI
%               'ImgCheck'  = check to analyze image (true) or VOI (false)

p = inputParser;
addRequired(p,'Vec',@isscalar);
addRequired(p,'Thresh',@isvector);
addRequired(p,'Window',@isvector);
addParamValue(p,'ApplyMask',true,@islogical);
parse(p,vec,thresh,n,varargin{:});
pp = p.Results;

varargin = {};
if (pp.Vec==0) && self.mask.check
    % Use existing VOI
    timg = double(self.mask.mat);
    pp.Thresh = 0.5;
elseif self.check
    timg = self.mat(:,:,:,pp.Vec);
    if pp.ApplyMask
        varargin = {self.mask.mat};
    end
else
    warning('No VOI exists for Minkowski Functional analysis.');
end

[MFout,labels] = minkowskiFun(timg,pp.Window,pp.Thresh,varargin{:});
if ~isempty(MFout) && (length(size(MFout))==5)
    d = size(MFout);
    labels = strcat(repmat(labels,d(4),1),repmat(cellfun(@num2str,num2cell(1:d(4))',...
                                            'UniformOutput',false),1,d(5)));
    self.imgAppend(reshape(MFout,[d(1:3),prod(d(4:end))]),labels);
end
